version: '3.8'

# ==============================================================================
# MORGANA + CAULDRON - DOCKER COMPOSE
# ==============================================================================
# Architecture:
# - morgana: Backend SignalR + API (port 5001)
# - cauldron: Frontend Blazor Server (port 5002)
# - Dedicated bridge network for internal communication
# - Persistent volume for SQLite databases

services:
  # ============================================================================
  # MORGANA - BACKEND (SignalR + API + Akka.NET + Microsoft.Agents.AI)
  # ============================================================================
  morgana:
    build:
      context: .
      dockerfile: Morgana.Dockerfile
      args:
        VERSION: ${MORGANA_VERSION}
    image: morgana:${MORGANA_VERSION}
    container_name: morgana
    ports:
      - "5001:5001"
    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001

      # Conversation persistence (SQLite)
      - Morgana__ConversationPersistence__StoragePath=/app/data
      - Morgana__ConversationPersistence__EncryptionKey=${ENCRYPTION_KEY}

      # LLM Provider (anthropic or azureopenai)
      - Morgana__LLM__Provider=${LLM_PROVIDER}
      - Morgana__LLM__Anthropic__ApiKey=${ANTHROPIC_APIKEY}
      - Morgana__LLM__Anthropic__Model=${ANTHROPIC_MODEL}
      - Morgana__LLM__AzureOpenAI__ApiKey=${AZURE_OPENAI_APIKEY}
      - Morgana__LLM__AzureOpenAI__DeploymentName=${AZURE_OPENAI_DEPLOYMENTNAME}
      - Morgana__LLM__AzureOpenAI__Endpoint=${AZURE_OPENAI_ENDPOINT}

      # CORS: Cauldron frontend URL
      - Morgana__Cauldron__BaseUrl=http://cauldron:5002
    volumes:
      # Persistent volume for SQLite databases
      - morgana-data:/app/data
    networks:
      - morgana-network

  # ============================================================================
  # CAULDRON - FRONTEND (Blazor Server UI)
  # ============================================================================
  cauldron:
    build:
      context: .
      dockerfile: Cauldron.Dockerfile
      args:
        VERSION: ${CAULDRON_VERSION}
    image: cauldron:${CAULDRON_VERSION}
    container_name: cauldron
    ports:
      - "5002:5002"
    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5002

      # Morgana backend URL (internal network communication)
      - Morgana__BaseUrl=http://morgana:5001
    depends_on:
      - morgana
    networks:
      - morgana-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  # SQLite database persistence (conversations + agent threads)
  morgana-data:
    driver: local

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  # Dedicated bridge network for internal container communication
  morgana-network:
    driver: bridge

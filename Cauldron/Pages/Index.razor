@page "/"
@using Cauldron.Services
@inject MorganaSignalRService SignalRService
@inject HttpClient Http
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>Morgana - Magical AI Assistant</PageTitle>

<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-content">
            <img src="images/morgana-avatar.png" 
                 alt="Morgana" 
                 class="header-avatar"
                 style="border: 3px solid @GetAvatarBorderColor(currentAgentName); !important" />
            <div class="header-info">
                <h1>@currentAgentName</h1>
                <span class="status @(isConnected ? "online" : "offline")">
                    @(isConnected ? "Online" : "Offline")
                </span>
            </div>
        </div>
    </div>

    <!-- Messages Area -->
    <div class="messages-container">
        @if (!isInitialized || messages.Count == 0)
        {
            <div class="magical-loader">
                <div class="magic-sparkle-core">
                    <div class="glow-core"></div>
                    <div class="glow-ring ring-1"></div>
                    <div class="glow-ring ring-2"></div>
                    <div class="glow-ring ring-3"></div>
                </div>
                <div class="sparkles-container">
                    <div class="sparkle sp1"></div>
                    <div class="sparkle sp2"></div>
                    <div class="sparkle sp3"></div>
                    <div class="sparkle sp4"></div>
                    <div class="sparkle sp5"></div>
                    <div class="sparkle sp6"></div>
                    <div class="sparkle sp7"></div>
                    <div class="sparkle sp8"></div>
                    <div class="sparkle sp9"></div>
                    <div class="sparkle sp10"></div>
                    <div class="sparkle sp11"></div>
                    <div class="sparkle sp12"></div>
                </div>
                <p class="loading-text">@(Configuration["Morgana:LandingMessage"])</p>
            </div>
        }
        else
        {
            @foreach (ChatMessage message in messages)
            {
                <div class="message @message.Role">
                    @if (message.Role == "assistant")
                    {
                        <img src="images/morgana-avatar.png" 
                             alt="@message.AgentName" 
                             class="message-avatar"
                             style="border: 2px solid @GetAvatarBorderColor(message.AgentName);" />
                    }
                    <div class="message-bubble">
                        @if (message.IsTyping)
                        {
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        }
                        else
                        {
                            <div class="message-text @(message.Type == MessageType.Presentation ? "completion-text" : "")">
                                @message.Text
                            </div>
                            
                            @if (message.QuickReplies is { Count: > 0 })
                            {
                                <div class="quick-replies @(message.SelectedQuickReplyId != null ? "disabled" : "")">
                                    @foreach (QuickReply reply in message.QuickReplies)
                                    {
                                        <button 
                                            class="quick-reply-btn @(message.SelectedQuickReplyId == reply.Id ? "selected" : "")"
                                            @onclick="() => SelectQuickReply(reply, message)"
                                            disabled="@(message.SelectedQuickReplyId != null)">
                                            @reply.Label
                                            @if (message.SelectedQuickReplyId == reply.Id)
                                            {
                                                <span class="checkmark">‚úì</span>
                                            }
                                        </button>
                                    }
                                </div>
                            }
                            
                            <div class="message-time">@message.Timestamp.ToString("HH:mm")</div>
                        }
                    </div>
                </div>
            }
        }
    </div>

    <!-- Input Area -->
    <div class="input-container">
        <textarea
            @bind="inputText"
            @bind:event="oninput"
            @onkeyup="HandleKeyPress"
            placeholder="Scrivi un messaggio..."
            rows="1"
            disabled="@IsTextareaDisabled"
            class="message-input"
        ></textarea>
        <button
            @onclick="SendMessage"
            disabled="@IsButtonDisabled"
            class="send-button @(isSending ? "sending" : "")">
            <span class="cauldron-wrapper">
                <span class="cauldron-icon">
                    <span class="cauldron-body"></span>
                    <span class="brew-surface"></span>
                    <span class="bubble b1"></span>
                    <span class="bubble b2"></span>
                    <span class="bubble b3"></span>
                    <span class="bubble b4"></span>
                    <span class="steam st1"></span>
                    <span class="steam st2"></span>
                    <span class="steam st3"></span>
                </span>
                <span class="magic-glow"></span>
                <span class="magic-ring"></span>
                <span class="sparkle s1"></span>
                <span class="sparkle s2"></span>
                <span class="sparkle s3"></span>
                <span class="sparkle s4"></span>
                <span class="sparkle s5"></span>
                <span class="sparkle s6"></span>
            </span>
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-banner">
            ‚ö†Ô∏è @errorMessage
        </div>
    }
</div>

@code {
    private List<ChatMessage> messages = [];
    private string inputText = string.Empty;
    private string conversationId = string.Empty;
    private bool isConnected = false;
    private bool isSending = false;
    private bool isInitialized = false;
    private string errorMessage = string.Empty;
    private string currentAgentName = "Morgana";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("üîµ OnInitializedAsync: Starting...");

            await SignalRService.StartAsync();
            isConnected = SignalRService.IsConnected;
            Console.WriteLine($"üîµ SignalR connected: {isConnected}");

            SignalRService.OnMessageReceived += async (conversationId, text, timestamp, quickReplies, agentName, agentCompleted) =>
            {
                await HandleMessageReceived(conversationId, text, timestamp, quickReplies, agentName, agentCompleted);
            };
            SignalRService.OnConnectionStateChanged += (connected) =>
            {
                isConnected = connected;
                Console.WriteLine($"üîµ Connection state changed: {connected}");
                InvokeAsync(StateHasChanged);
            };

            await StartConversation();
            isInitialized = true;
            errorMessage = string.Empty;
            Console.WriteLine($"üîµ Initialized with conversationId: {conversationId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Initialization error: {ex.Message}");
            errorMessage = $"Errore di inizializzazione: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task StartConversation()
    {
        try
        {
            Console.WriteLine("üü¢ StartConversation: Calling Morgana...");

            HttpResponseMessage response = await Http.PostAsJsonAsync("/api/conversation/start", new
            {
                conversationId = Guid.NewGuid().ToString("N")
            });

            Console.WriteLine($"üü¢ Morgana Response Status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                ConversationStartResponse? result = await response.Content.ReadFromJsonAsync<ConversationStartResponse>();
                conversationId = result?.ConversationId ?? string.Empty;

                Console.WriteLine($"üü¢ ConversationId received: {conversationId}");

                if (string.IsNullOrEmpty(conversationId))
                    throw new Exception("ConversationId is empty!");

                await SignalRService.JoinConversation(conversationId);

                Console.WriteLine($"üü¢ Joined SignalR group: {conversationId}");
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                throw new Exception($"Morgana error: {response.StatusCode} - {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting conversation: {ex.Message}");
            errorMessage = $"Impossibile avviare la conversazione: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(inputText) || isSending || string.IsNullOrEmpty(conversationId))
        {
            Console.WriteLine($"‚ùå SendMessage blocked: inputText={inputText}, isSending={isSending}, conversationId={conversationId}");
            return;
        }

        string messageText = inputText.Trim().TrimEnd('\0');
        inputText = string.Empty;
        errorMessage = string.Empty;
        isSending = true;

        StateHasChanged();

        Console.WriteLine($"üü° Sending message: '{messageText}' to conversation: {conversationId}");

        messages.Add(new ChatMessage
        {
            ConversationId = conversationId,
            Text = messageText,
            Role = "user",
            Timestamp = DateTime.Now
        });

        messages.Add(new ChatMessage
        {
            ConversationId = conversationId,
            Role = "assistant",
            IsTyping = true,
            Timestamp = DateTime.Now
        });

        StateHasChanged();

        try
        {
            HttpResponseMessage response = await Http.PostAsJsonAsync($"/api/conversation/{conversationId}/message", new
            {
                conversationId = conversationId,
                text = messageText
            });

            Console.WriteLine($"üü° Message sent, response status: {response.StatusCode}");

            if (!response.IsSuccessStatusCode)
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Morgana error: {errorContent}");

                ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
                if (typingMessage != null)
                {
                    messages.Remove(typingMessage);
                    messages.Add(new ChatMessage
                    {
                        ConversationId = conversationId,
                        Text = "Mi dispiace, si √® verificato un errore. Riprova.",
                        Role = "assistant",
                        Timestamp = DateTime.Now,
                        IsError = true,
                        AgentName = "Morgana"
                    });
                    StateHasChanged();
                }

                errorMessage = $"Errore nell'invio: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå SendMessage exception: {ex.Message}");

            ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
            if (typingMessage != null)
            {
                messages.Remove(typingMessage);
                messages.Add(new ChatMessage
                {
                    ConversationId = conversationId,
                    Text = $"Errore di connessione: {ex.Message}",
                    Role = "assistant",
                    Timestamp = DateTime.Now,
                    IsError = true,
                    AgentName = "Morgana"
                });

                errorMessage = $"Errore: {ex.Message}";
                StateHasChanged();
            }
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    private async Task HandleMessageReceived(string conversationId, string text, DateTime timestamp, List<QuickReply>? quickReplies, string? agentName, bool agentCompleted)
    {
        try
        {
            Console.WriteLine($"üü£ Message received for conversation: {conversationId}");
            Console.WriteLine($"üü£ Agent: {agentName ?? "Morgana"}, Completed: {agentCompleted}");
            Console.WriteLine($"üü£ QuickReplies count: {quickReplies?.Count ?? 0}");

            if (this.conversationId != conversationId)
            {
                Console.WriteLine("‚ö†Ô∏è Message for different conversation, ignoring");
                return;
            }

            ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
            if (typingMessage != null)
            {
                messages.Remove(typingMessage);
            }

            // Aggiorna il nome dell'agente nell'header
            if (!string.IsNullOrEmpty(agentName))
            {
                currentAgentName = agentName;
                Console.WriteLine($"üé® Header updated: {currentAgentName} ‚Üí Color: {GetAvatarBorderColor(currentAgentName)}");
            }

            // Se l'agente ha completato, torna a Morgana
            if (agentCompleted)
            {
                currentAgentName = "Morgana";
                Console.WriteLine($"üé® Header reset to: {currentAgentName} ‚Üí Color: {GetAvatarBorderColor(currentAgentName)}");
            }

            // Messaggio principale dall'agente
            messages.Add(new ChatMessage
            {
                ConversationId = conversationId,
                Text = text,
                Role = "assistant",
                Timestamp = timestamp,
                QuickReplies = quickReplies,
                AgentName = agentName ?? "Morgana",
                AgentCompleted = false
            });

            // Se l'agente ha completato E non √® Morgana base, aggiungi un messaggio separato
            if (agentCompleted && IsSpecializedAgent(agentName))
            {
                messages.Add(new ChatMessage
                {
                    ConversationId = conversationId,
                    Text = GetCompletionMessage(agentName!),
                    Role = "assistant",
                    Timestamp = timestamp.AddSeconds(1),
                    AgentName = "Morgana",
                    AgentCompleted = false,
                    Type = MessageType.Presentation
                });
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in HandleMessageReceived: {ex.Message}");
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e is { Key: "Enter", ShiftKey: false })
        {
            await SendMessage();
        }
    }

    private async Task SelectQuickReply(QuickReply reply, ChatMessage message)
    {
        if (message.SelectedQuickReplyId != null) return;
        
        Console.WriteLine($"üü° Quick reply selected: {reply.Label}");
        
        message.SelectedQuickReplyId = reply.Id;
        StateHasChanged();
        
        await Task.Delay(300); // Visual feedback
        
        inputText = reply.Value;
        await SendMessage();
    }

    private bool HasActiveQuickReplies() =>
        messages.Any(m => m is { QuickReplies: not null, SelectedQuickReplyId: null });

    private bool IsButtonDisabled =>
        !isConnected ||
        isSending ||
        string.IsNullOrWhiteSpace(inputText) ||
        !isInitialized ||
        HasActiveQuickReplies() ||
        messages.Any(m => m.IsTyping);

    private bool IsTextareaDisabled =>
        !isConnected ||
        isSending ||
        !isInitialized ||
        HasActiveQuickReplies() ||
        messages.Any(m => m.IsTyping);

    public async ValueTask DisposeAsync()
    {
        SignalRService.OnMessageReceived -= async (conversationId, text, timestamp, quickReplies, agentName, agentCompleted) =>
        {
            await HandleMessageReceived(conversationId, text, timestamp, quickReplies, agentName, agentCompleted);
        };
        await SignalRService.StopAsync();
    }

    private bool IsSpecializedAgent(string agentName)
    {
        return agentName != null && agentName.Contains("(") && agentName.Contains(")");
    }

    private string GetAvatarBorderColor(string? agentName)
    {
        // Viola per Morgana base, Rosa per agenti specializzati
        return IsSpecializedAgent(agentName ?? "Morgana") ? "var(--secondary-color)" : "var(--primary-color)";
    }

    private string GetCompletionMessage(string agentName)
    {
        if (agentName.Contains("(") && agentName.Contains(")"))
            return string.Format(Configuration["Morgana:AgentExitMessage"]!, agentName);

        return "üå∏ L'incantesimo √® stato completato";
    }
}
@page "/"
@using Cauldron.Services
@inject MorganaSignalRService SignalRService
@inject MorganaLandingMessageService LandingMessageService
@inject HttpClient Http
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>Morgana - Magical AI Assistant</PageTitle>

<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-content">
            <img src="images/morgana-avatar.png" 
                 alt="Morgana" 
                 class="header-avatar"
                 style="border: 3px solid @GetAvatarBorderColor(currentAgentName); !important" />
            <div class="header-info">
                <h1>@currentAgentName</h1>
                <span class="status @(isConnected ? "online" : "offline")">
                    @(isConnected ? "Online" : "Offline")
                </span>
            </div>
        </div>
    </div>

    <!-- Messages Area -->
    <div class="messages-container">
        @if (!isInitialized || messages.Count == 0)
        {
            <!-- Loading state with magical animation -->
            <div class="magical-loader">
                <div class="magic-sparkle-core">
                    <div class="glow-core"></div>
                    <div class="glow-ring ring-1"></div>
                    <div class="glow-ring ring-2"></div>
                    <div class="glow-ring ring-3"></div>
                </div>
                <div class="sparkles-container">
                    <div class="sparkle sp1"></div>
                    <div class="sparkle sp2"></div>
                    <div class="sparkle sp3"></div>
                    <div class="sparkle sp4"></div>
                    <div class="sparkle sp5"></div>
                    <div class="sparkle sp6"></div>
                    <div class="sparkle sp7"></div>
                    <div class="sparkle sp8"></div>
                    <div class="sparkle sp9"></div>
                    <div class="sparkle sp10"></div>
                    <div class="sparkle sp11"></div>
                    <div class="sparkle sp12"></div>
                </div>
                <p class="loading-text">@(landingMessage)</p>
            </div>
        }
        else
        {
            <!-- Message list -->
            @foreach (ChatMessage message in messages)
            {
                <div class="message @message.Role">
                    @if (message.Role == "assistant")
                    {
                        <!-- Agent avatar with dynamic border color -->
                        <img src="images/morgana-avatar.png" 
                             alt="@message.AgentName" 
                             class="message-avatar"
                             style="border: 2px solid @GetAvatarBorderColor(message.AgentName);" />
                    }
                    <div class="message-bubble">
                        @if (message.IsTyping)
                        {
                            <!-- Typing indicator (three animated dots) -->
                            <div class="typing-indicator">
                                <span style="background: @GetAvatarBorderColor(message.AgentName);"></span>
                                <span style="background: @GetAvatarBorderColor(message.AgentName);"></span>
                                <span style="background: @GetAvatarBorderColor(message.AgentName);"></span>
                            </div>
                        }
                        else
                        {
                            <!-- Message content -->
                            <div class="message-text @(message.Type == MessageType.Presentation ? "completion-text" : "")">
                                @message.Text
                            </div>

                            @if (message.QuickReplies is { Count: > 0 })
                            {
                                <QuickReplyButton Replies="@message.QuickReplies"
                                                  OnSelect="@((reply) => SelectQuickReply(reply, message))"
                                                  IsDisabled="@(message.SelectedQuickReplyId != null)"
                                                  SelectedReplyId="@message.SelectedQuickReplyId" />
                            }

                            <!-- Message timestamp -->
                            <div class="message-time">@message.Timestamp.ToString("HH:mm")</div>
                        }
                    </div>
                </div>
            }
        }
    </div>

    <!-- Input Area -->
    <div class="input-container">
        <textarea
            @bind="inputText"
            @bind:event="oninput"
            @onkeyup="HandleKeyPress"
            placeholder="Consult @(currentAgentName)..."
            rows="1"
            disabled="@IsTextareaDisabled"
            class="message-input @(IsSpecializedAgent(currentAgentName) ? "agent" : "morgana")"></textarea>
        <button
            @onclick="SendMessage"
            disabled="@IsButtonDisabled"
            class="send-button @(isSending ? "sending" : "") @(IsSpecializedAgent(currentAgentName) ? "agent" : "morgana")">
            <!-- Animated cauldron icon with magical effects -->
            <span class="cauldron-wrapper">
                <span class="cauldron-icon">
                    <span class="cauldron-body @(IsSpecializedAgent(currentAgentName) ? "agent" : "morgana")"></span>
                    <span class="brew-surface"></span>
                    <span class="bubble b1"></span>
                    <span class="bubble b2"></span>
                    <span class="bubble b3"></span>
                    <span class="bubble b4"></span>
                    <span class="steam st1"></span>
                    <span class="steam st2"></span>
                    <span class="steam st3"></span>
                </span>
                <span class="magic-glow"></span>
                <span class="magic-ring"></span>
                <span class="sparkle s1"></span>
                <span class="sparkle s2"></span>
                <span class="sparkle s3"></span>
                <span class="sparkle s4"></span>
                <span class="sparkle s5"></span>
                <span class="sparkle s6"></span>
            </span>
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <!-- Error banner -->
        <div class="error-banner">
            ‚ö†Ô∏è @errorMessage
        </div>
    }
</div>

@code {
    // =========================================================================
    // STATE VARIABLES
    // =========================================================================
    
    /// <summary>
    /// List of all chat messages in the current conversation.
    /// Includes user messages, agent responses, typing indicators, and presentation messages.
    /// </summary>
    private List<ChatMessage> messages = [];
    
    /// <summary>
    /// Current text input from the user (two-way bound to textarea).
    /// </summary>
    private string inputText = string.Empty;
    
    /// <summary>
    /// Unique identifier for the current conversation.
    /// Generated on conversation start and used for message routing.
    /// </summary>
    private string conversationId = string.Empty;
    
    /// <summary>
    /// SignalR connection state indicator.
    /// True when connected and ready to receive messages.
    /// </summary>
    private bool isConnected = false;
    
    /// <summary>
    /// Message send operation in progress indicator.
    /// True during HTTP POST to prevent duplicate sends.
    /// </summary>
    private bool isSending = false;
    
    /// <summary>
    /// Initialization complete indicator.
    /// True after SignalR connection and conversation start succeed.
    /// </summary>
    private bool isInitialized = false;
    
    /// <summary>
    /// Error message to display in error banner.
    /// Empty string when no error present.
    /// </summary>
    private string errorMessage = string.Empty;
    
    /// <summary>
    /// Name of the currently active agent.
    /// Updates dynamically when agents take control: "Morgana", "Billing", etc.
    /// Displayed in header and used for avatar border color.
    /// </summary>
    private string currentAgentName = "Morgana";

    /// <summary>
    /// Landing message (waiting for Morgana presentation).
    /// </summary>
    private string landingMessage = string.Empty;

    // =========================================================================
    // LIFECYCLE METHODS
    // =========================================================================

    /// <summary>
    /// Blazor lifecycle method called when component is initialized.
    /// Sets up SignalR connection, subscribes to events, and starts conversation.
    /// </summary>
    /// <returns>Task representing the async initialization</returns>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("üîµ OnInitializedAsync: Starting...");

            // Initialize landing message
            landingMessage = LandingMessageService.GetRandomMessage();

            // Start SignalR connection
            await SignalRService.StartAsync();
            isConnected = SignalRService.IsConnected;
            Console.WriteLine($"üîµ SignalR connected: {isConnected}");

            // Subscribe to message received events
            SignalRService.OnMessageReceived += async (conversationId, text, timestamp, quickReplies, agentName, agentCompleted) =>
            {
                await HandleMessageReceived(conversationId, text, timestamp, quickReplies, agentName, agentCompleted);
            };
            
            // Subscribe to connection state changes
            SignalRService.OnConnectionStateChanged += (connected) =>
            {
                isConnected = connected;
                Console.WriteLine($"üîµ Connection state changed: {connected}");
                InvokeAsync(StateHasChanged);
            };

            // Start conversation and get presentation message
            await StartConversation();
            isInitialized = true;
            errorMessage = string.Empty;
            Console.WriteLine($"üîµ Initialized with conversationId: {conversationId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Initialization error: {ex.Message}");
            errorMessage = $"Initialization error: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    // =========================================================================
    // CONVERSATION MANAGEMENT
    // =========================================================================

    /// <summary>
    /// Starts a new conversation with Morgana backend.
    /// Sends POST request to /api/conversation/start, joins SignalR group, and displays presentation message.
    /// </summary>
    /// <returns>Task representing the async conversation start operation</returns>
    /// <remarks>
    /// <para><strong>Flow:</strong></para>
    /// <list type="number">
    /// <item>Generate new conversation ID (GUID)</item>
    /// <item>POST to /api/conversation/start</item>
    /// <item>Extract conversationId from response</item>
    /// <item>Join SignalR conversation group</item>
    /// <item>Wait for presentation message via SignalR</item>
    /// <item>Display presentation with quick replies</item>
    /// </list>
    /// </remarks>
    private async Task StartConversation()
    {
        try
        {
            Console.WriteLine("üü¢ StartConversation: Calling Morgana...");

            // Generate new conversation ID
            HttpResponseMessage response = await Http.PostAsJsonAsync("/api/conversation/start", new
            {
                conversationId = Guid.NewGuid().ToString("N")
            });

            Console.WriteLine($"üü¢ Morgana Response Status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                // Parse response to get conversation ID
                var result = await response.Content.ReadFromJsonAsync<ConversationStartResponse>();
                conversationId = result?.ConversationId ?? string.Empty;

                Console.WriteLine($"üü¢ Conversation started: {conversationId}");

                // Join SignalR group for this conversation
                await SignalRService.JoinConversation(conversationId);

                Console.WriteLine($"üü¢ Waiting for presentation message...");
                // Presentation message will arrive via SignalR OnMessageReceived event
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Morgana error: {errorContent}");
                errorMessage = $"Conversation start error: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå StartConversation exception: {ex.Message}");
            errorMessage = $"Error: {ex.Message}";
        }
    }

    // =========================================================================
    // MESSAGE HANDLING
    // =========================================================================

    /// <summary>
    /// Sends a user message to Morgana backend via REST API.
    /// Adds user message and typing indicator to UI, then waits for agent response via SignalR.
    /// </summary>
    /// <returns>Task representing the async send operation</returns>
    /// <remarks>
    /// <para><strong>Flow:</strong></para>
    /// <list type="number">
    /// <item>Validate input text</item>
    /// <item>Add user message to messages list</item>
    /// <item>Add typing indicator to messages list</item>
    /// <item>Update UI</item>
    /// <item>POST to /api/conversation/{conversationId}/message</item>
    /// <item>Wait for response via SignalR (async)</item>
    /// <item>HandleMessageReceived removes typing indicator and adds agent response</item>
    /// </list>
    /// <para><strong>Error Handling:</strong></para>
    /// <para>On HTTP error or exception, typing indicator is removed and error message displayed.</para>
    /// </remarks>
    private async Task SendMessage()
    {
        // Validate input
        if (string.IsNullOrWhiteSpace(inputText) || isSending || !isConnected)
            return;

        string messageText = inputText.Trim();
        inputText = string.Empty;
        isSending = true;

        // Add user message to UI
        messages.Add(new ChatMessage
        {
            ConversationId = conversationId,
            Text = messageText,
            Role = "user",
            Timestamp = DateTime.Now
        });

        // Add typing indicator
        messages.Add(new ChatMessage
        {
            ConversationId = conversationId,
            Role = "assistant",
            IsTyping = true,
            AgentName = currentAgentName,
            Timestamp = DateTime.Now
        });

        StateHasChanged();

        try
        {
            // Send message to backend
            HttpResponseMessage response = await Http.PostAsJsonAsync($"/api/conversation/{conversationId}/message", new
            {
                conversationId = conversationId,
                text = messageText
            });

            Console.WriteLine($"üü° Message sent, response status: {response.StatusCode}");

            if (!response.IsSuccessStatusCode)
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Morgana error: {errorContent}");

                // Remove typing indicator and show error
                ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
                if (typingMessage != null)
                {
                    messages.Remove(typingMessage);
                    messages.Add(new ChatMessage
                    {
                        ConversationId = conversationId,
                        Text = "Sorry, an error occurred. Please try again.",
                        Role = "assistant",
                        Timestamp = DateTime.Now,
                        IsError = true,
                        AgentName = "Morgana"
                    });
                    StateHasChanged();
                }

                errorMessage = $"Error sending: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå SendMessage exception: {ex.Message}");

            // Remove typing indicator and show error
            ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
            if (typingMessage != null)
            {
                messages.Remove(typingMessage);
                messages.Add(new ChatMessage
                {
                    ConversationId = conversationId,
                    Text = $"Connection error: {ex.Message}",
                    Role = "assistant",
                    Timestamp = DateTime.Now,
                    IsError = true,
                    AgentName = "Morgana"
                });

                errorMessage = $"Error: {ex.Message}";
                StateHasChanged();
            }
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Handles incoming messages from SignalR (agent responses, presentation messages).
    /// Removes typing indicator, adds agent message to UI, and updates header with current agent.
    /// </summary>
    /// <param name="conversationId">Conversation ID of the message</param>
    /// <param name="text">Message text from agent</param>
    /// <param name="timestamp">Message timestamp</param>
    /// <param name="quickReplies">Optional list of quick reply buttons</param>
    /// <param name="agentName">Name of the responding agent</param>
    /// <param name="agentCompleted">True if agent has completed its task</param>
    /// <returns>Task representing the async message handling</returns>
    /// <remarks>
    /// <para><strong>Agent Lifecycle:</strong></para>
    /// <list type="bullet">
    /// <item><term>Agent Active</term><description>agentCompleted = false, header shows agent name with specialized color</description></item>
    /// <item><term>Agent Completed</term><description>agentCompleted = true, header returns to "Morgana" with base color, completion message added</description></item>
    /// </list>
    /// </remarks>
    private async Task HandleMessageReceived(string conversationId, string text, DateTime timestamp, List<QuickReply>? quickReplies, string? agentName, bool agentCompleted)
    {
        try
        {
            Console.WriteLine($"üü£ Message received for conversation: {conversationId}");
            Console.WriteLine($"üü£ Agent: {agentName ?? "Morgana"}, Completed: {agentCompleted}");
            Console.WriteLine($"üü£ QuickReplies count: {quickReplies?.Count ?? 0}");

            // Verify message is for this conversation
            if (this.conversationId != conversationId)
            {
                Console.WriteLine("‚ö†Ô∏è Message for different conversation, ignoring");
                return;
            }

            // Remove typing indicator
            ChatMessage? typingMessage = messages.LastOrDefault(m => m.IsTyping);
            if (typingMessage != null)
            {
                messages.Remove(typingMessage);
            }

            // Update header with current agent name
            if (!string.IsNullOrEmpty(agentName))
            {
                currentAgentName = agentName;
                Console.WriteLine($"üé® Header updated: {currentAgentName} ‚Üí Color: {GetAvatarBorderColor(currentAgentName)}");
            }

            // If agent has completed, return header to Morgana
            if (agentCompleted)
            {
                currentAgentName = "Morgana";
                Console.WriteLine($"üé® Header reset to: {currentAgentName} ‚Üí Color: {GetAvatarBorderColor(currentAgentName)}");
            }

            // Add main agent message
            messages.Add(new ChatMessage
            {
                ConversationId = conversationId,
                Text = text,
                Role = "assistant",
                Timestamp = timestamp,
                QuickReplies = quickReplies,
                AgentName = agentName ?? "Morgana",
                AgentCompleted = false
            });

            // If agent completed and is specialized, add completion message from Morgana
            if (agentCompleted && IsSpecializedAgent(agentName))
            {
                messages.Add(new ChatMessage
                {
                    ConversationId = conversationId,
                    Text = GetCompletionMessage(agentName!),
                    Role = "assistant",
                    Timestamp = timestamp.AddSeconds(1),
                    AgentName = "Morgana",
                    AgentCompleted = false,
                    Type = MessageType.Presentation
                });
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in HandleMessageReceived: {ex.Message}");
        }
    }

    // =========================================================================
    // UI INTERACTION HANDLERS
    // =========================================================================

    /// <summary>
    /// Handles keyboard events in textarea (Enter to send, Shift+Enter for newline).
    /// </summary>
    /// <param name="e">Keyboard event args</param>
    /// <returns>Task representing the async key handling</returns>
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        // Send message on Enter (without Shift)
        if (e is { Key: "Enter", ShiftKey: false })
        {
            await SendMessage();
        }
    }

    /// <summary>
    /// Handles quick reply button selection.
    /// Marks the selected reply, disables all buttons, and sends the reply value as user message.
    /// </summary>
    /// <param name="reply">Selected quick reply definition</param>
    /// <param name="message">Message containing the quick replies</param>
    /// <returns>Task representing the async selection handling</returns>
    private async Task SelectQuickReply(QuickReply reply, ChatMessage message)
    {
        // Prevent multiple selections
        if (message.SelectedQuickReplyId != null) return;

        Console.WriteLine($"üü° Quick reply selected: {reply.Label}");

        // Mark as selected and update UI
        message.SelectedQuickReplyId = reply.Id;
        StateHasChanged();

        // Visual feedback delay
        await Task.Delay(250);

        // Send the quick reply value as user message
        inputText = reply.Value;
        await SendMessage();
    }

    // =========================================================================
    // UI STATE HELPERS
    // =========================================================================

    /// <summary>
    /// Checks if there are any unselected quick replies in the message list.
    /// </summary>
    /// <returns>True if any message has quick replies that haven't been selected yet</returns>
    private bool HasActiveQuickReplies() =>
        messages.Any(m => m is { QuickReplies: not null, SelectedQuickReplyId: null });

    /// <summary>
    /// Gets a value indicating whether the send button should be disabled.
    /// Disabled when: not connected, sending in progress, empty input, not initialized, has active quick replies, or typing indicator present.
    /// </summary>
    private bool IsButtonDisabled =>
        !isConnected ||
        isSending ||
        string.IsNullOrWhiteSpace(inputText) ||
        !isInitialized ||
        HasActiveQuickReplies() ||
        messages.Any(m => m.IsTyping);

    /// <summary>
    /// Gets a value indicating whether the textarea should be disabled.
    /// Disabled when: not connected, sending in progress, not initialized, has active quick replies, or typing indicator present.
    /// </summary>
    private bool IsTextareaDisabled =>
        !isConnected ||
        isSending ||
        !isInitialized ||
        HasActiveQuickReplies() ||
        messages.Any(m => m.IsTyping);

    // =========================================================================
    // CLEANUP
    // =========================================================================

    /// <summary>
    /// Disposes component resources.
    /// Unsubscribes from SignalR events and stops connection.
    /// </summary>
    /// <returns>ValueTask representing the async dispose operation</returns>
    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from events
        SignalRService.OnMessageReceived -= async (conversationId, text, timestamp, quickReplies, agentName, agentCompleted) =>
        {
            await HandleMessageReceived(conversationId, text, timestamp, quickReplies, agentName, agentCompleted);
        };
        
        // Stop SignalR connection
        await SignalRService.StopAsync();
    }

    // =========================================================================
    // HELPER METHODS
    // =========================================================================

    /// <summary>
    /// Determines if an agent name represents a specialized agent (not base Morgana).
    /// Specialized agents have names with parentheses, e.g., "Morgana (Billing)".
    /// </summary>
    /// <param name="agentName">Agent name to check</param>
    /// <returns>True if specialized agent, false if base Morgana</returns>
    private bool IsSpecializedAgent(string agentName)
    {
        return agentName != null && agentName.Contains("(") && agentName.Contains(")");
    }

    /// <summary>
    /// Gets the CSS color variable for the avatar border based on agent type.
    /// </summary>
    /// <param name="agentName">Name of the current agent</param>
    /// <returns>
    /// "var(--secondary-color)" (pink) for specialized agents,
    /// "var(--primary-color)" (purple) for base Morgana
    /// </returns>
    private string GetAvatarBorderColor(string? agentName)
    {
        // Pink for specialized agents, purple for base Morgana
        return IsSpecializedAgent(agentName ?? "Morgana") ? "var(--secondary-color)" : "var(--primary-color)";
    }

    /// <summary>
    /// Gets the completion message to display when an agent finishes its task.
    /// Uses configured template from appsettings or default message.
    /// </summary>
    /// <param name="agentName">Name of the agent that completed</param>
    /// <returns>Formatted completion message</returns>
    private string GetCompletionMessage(string agentName)
    {
        // For specialized agents, use configured template
        if (agentName.Contains("(") && agentName.Contains(")"))
            return string.Format(Configuration["Morgana:AgentExitMessage"]!, agentName);

        // Default fallback
        return "The spell has been completed";
    }
}